name: VNC MuMu (Cloudflare Direct)
on: workflow_dispatch

jobs:
  vnc:
    runs-on: windows-latest
    steps:
      - name: Install VNC & Cloudflared
        run: |
          choco install tightvnc cloudflared -y
          pip install websockify

      - name: Start VNC Server
        run: |
          $pass = "VNCpass123!"
          & "C:\Program Files\TightVNC\tvnserver.exe" -silent -controlservice -set AdminPasswordPlain="$pass"
          Start-Service -Name "tvnserver"

      - name: Start Web Bridge
        run: |
          # Converts VNC to a browser-friendly format on port 6080
          Start-Process powershell -ArgumentList "-Command","python -m websockify 6080 localhost:5900" -WindowStyle Hidden

      - name: Launch Cloudflare Tunnel
        shell: pwsh
        run: |
          Write-Host "Creating secure tunnel..."
          # This starts a public tunnel to your local port 6080
          Start-Process cloudflared -ArgumentList "tunnel --url http://127.0.0.1:6080" -RedirectStandardOutput "cloudflare.log"
          
          Write-Host "Waiting for URL..."
          Start-Sleep -Seconds 15
          
          # This grabs the random .trycloudflare.com link from the log file
          $url = Get-Content "cloudflare.log" | Select-String -Pattern "https://.*\.trycloudflare\.com" | ForEach-Object { $_.Matches.Value }
          
          Write-Host "=========================================="
          Write-Host "ACCESS URL: $url"
          Write-Host "VNC PASSWORD: VNCpass123!"
          Write-Host "=========================================="
          
          # Keep the VM alive
          while($true) { Start-Sleep 300 }
