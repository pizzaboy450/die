name: VNC with MuMu Player (Ngrok Stable)

on:
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'Enter your Ngrok Auth Token'
        required: true

jobs:
  vnc-setup:
    runs-on: windows-latest
    timeout-minutes: 3600
    
    steps:
      - name: Create VNC User
        run: |
          $password = "MumuPlayer123!"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "VNCUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "VNCUser"
          echo "VNC_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Tools (VNC & Python)
        run: |
          choco install tightvnc -y
          pip install websockify numpy

      - name: Configure VNC Server
        run: |
          $regPath = "HKLM:\SOFTWARE\TightVNC\Server"
          Set-ItemProperty -Path $regPath -Name "UseVncAuthentication" -Value 1 -Force
          & "C:\Program Files\TightVNC\tvnserver.exe" -silent -controlservice -set AdminPasswordPlain="$env:VNC_PASSWORD"
          Start-Service -Name "tvnserver"

      - name: Start Websockify Proxy
        run: |
          Start-Process powershell -ArgumentList "-NoExit","-Command","python -m websockify --web=. 0.0.0.0:6080 localhost:5900" -WindowStyle Hidden
          Start-Sleep -Seconds 5

      - name: Setup & Start Ngrok
        run: |
          choco install ngrok -y
          ngrok config add-authtoken "${{ github.event.inputs.ngrok_token }}"
          Start-Process ngrok -ArgumentList "http 6080" -WindowStyle Hidden
          Start-Sleep -Seconds 10

      - name: Get Ngrok URL
        run: |
          $json = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels
          $url = $json.tunnels[0].public_url
          Write-Host "`n=========================================="
          Write-Host "VNC URL: $url"
          Write-Host "PASSWORD: $env:VNC_PASSWORD"
          Write-Host "==========================================`n"

      - name: Maintain Connection
        run: |
          Write-Host "ðŸŸ¢ SESSION ACTIVE ON NGROK!"
          while ($true) { Start-Sleep -Seconds 300 }
